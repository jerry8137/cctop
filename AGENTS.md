# AGENTS.md

> **For AI Agents**: This file contains critical context, conventions, and commands for working on this repository. Read this before starting any task.

## 1. Project Overview
**cctop** is an HTOP-like TUI monitor for Claude Code agents, built with **Python 3.12** and **Textual**.
It parses real-time logs (`~/.claude/projects/*.jsonl`), calculates costs (Opus/Sonnet/Haiku), and displays agent status.

## 2. Development Environment
This project uses `uv` for dependency management.

### Key Commands
| Action | Command |
|--------|---------|
| **Install** | `uv sync --extra dev` |
| **Run App** | `uv run python main.py` |
| **Run All Tests** | `uv run pytest tests/ -v` |
| **Run Single Test** | `uv run pytest tests/test_file.py::test_func -v` |
| **Format Code** | `uv run black .` |
| **Type Check** | `uv run mypy src` |

## 3. Code Style & Conventions
**Strict adherence required.** The codebase is disciplined.

### Imports
- **Sort Order**: Standard Lib → Third Party → Local (src).
- **Grouping**: Group `from` imports together, then `import` statements.
- **Local Imports**: Use relative imports within packages (e.g., `from ..models.agent import Agent`).

### Typing (Python 3.12+)
- **Strict Typing**: All function signatures MUST have type hints.
- **No Implicit Optional**: Use `str | None = None` or `Optional[str] = None`, NEVER `str = None`.
- **Return Types**: explicit `-> None`, `-> str`, etc.
- **Collections**: Use `List`, `Dict`, `Optional` from `typing` or built-ins (`list[str]`).
- **Numbers**: Use `decimal.Decimal` for ALL pricing/cost calculations. Floats are forbidden for currency.

### Naming
- **Classes**: `PascalCase` (e.g., `LogFileWatcher`).
- **Functions/Variables**: `snake_case`.
- **Constants**: `UPPER_SNAKE_CASE`.
- **Private**: Prefix with `_` (e.g., `_update_ui`).

### Docstrings
- **Style**: Google Style.
- **Required**: All classes and public methods must have docstrings.
- **Format**:
  ```python
  """Brief summary.

  Args:
      param_name: Description.

  Returns:
      Description of return value.
  """
  ```

### Error Handling
- **Specific Exceptions**: Catch specific errors (`FileNotFoundError`), not bare `Exception`.
- **Graceful Failure**: UI should not crash on log parsing errors; log warning and continue.

## 4. Testing Strategy
- **Framework**: `pytest` with `pytest-asyncio`.
- **Location**: `tests/`.
- **Fixtures**: Use `tests/fixtures/` for sample log data.
- **Mocking**: heavily used for file I/O and network calls (pricing fetcher).
- **Coverage**: Ensure new logic is tested.

## 5. Architecture & Patterns
- **Three-Tier Architecture**:
  1. **Parsers** (`src/cctop/parsers`): Extract data from JSONL.
  2. **Aggregator** (`src/cctop/models`): Process logic/state.
  3. **UI** (`src/cctop/widgets`): Textual widgets (dumb components).
- **Communication**: Aggregator pushes data to App, App calls `update()` on Widgets.
- **State**: `Agent` objects are dataclasses.
- **Pricing**: 3-layer fallback (Live -> Cache -> Bundled).

## 6. Common Pitfalls to Avoid
- **Async/Sync Mixing**: Textual is async. Watch out for blocking I/O in the main thread.
- **Float Math**: NEVER use floats for token costs. Use `Decimal`.
- **Path Handling**: Always use `pathlib.Path`, never string manipulation for paths.

## 7. Current Codebase State (Notes)
- `mypy` is currently strict about `Optional`. You may see errors like "Incompatible default for argument". Fix these by explicit `| None` typing.
- `dateutil` and `psutil` type stubs might be missing in some environments; ignore if necessary but prefer installing types.

---
*Generated by Sisyphus on 2026-01-08*
